clear

h = 10^-1;
D = 30;

N = D/h + 1;

J = @(X) CostFunction(X);

nonlcon = @(X) Constraints(X);

X0 = zeros(5*N, 1);

% X0(3*N+1:4*N) = [0	9789.32505856009	19420.4324149515	28887.0718158853	38188.7549701770	47326.5048336954	56301.9362174580	65116.9422174679	73773.5591062454	82273.8990245298	90620.1129399948	98814.3687343593	106858.837516364	114755.684709697	122507.064061620	130115.113516350	137581.952322307	144909.678980826	152100.369783698	159156.077772025	166078.832002387	172870.637040937	179533.472629064	186069.293479806	192480.029175066	198767.584141235	204933.837686331	210980.644085720	216909.832706399	222723.208162051	228422.550492675	234009.615363919	239486.134282163	244853.814822199	250114.340864916	255269.372842897	260320.547992188	265269.480608808	270117.762308818	274866.962290957	279518.627601018	284074.283397263	288535.433216303	292903.559238941	297180.122555564	301366.563430723	305464.301566619	309474.736365213	313399.247188773	317239.193618647	320995.915712130	324670.734257276	328264.951025552	331779.849022237	335216.692734494	338576.728377037	341861.184135352	345071.270406423	348208.180036929	351273.088558877	354267.154422666	357191.519227548	360047.307949491	362835.629166432	365557.575280912	368214.222740111	370806.632253266	373335.849006502	375802.902875064	378208.808632980	380554.566160153	382841.160646909	385069.562796011	387240.729022156	389355.601648975	391415.109103561	393420.166108533	395371.673871670	397270.520273126	399117.580050255	400913.714980069	402659.774059340	404356.593682392	406004.997816581	407605.798175501	409159.794389944	410667.774176625	412130.513504700	413548.776760111	414923.316907769	416254.875651605	417544.183592514	418791.960384213	419998.914887041	421165.745319719	422293.139409101	423381.774537930	424432.317890635	425445.426597181	426421.747875004	427361.919169043	428266.568289907	429136.313550187	429971.763898942	430773.519054376	431542.169634740	432278.297287463	432982.474816553	433655.266308270	434297.227255114	434908.904678130	435490.837247564	436043.555401879	436567.581465167	437063.429762964	437531.606736494	437972.611055357	438386.933728696	438775.058214838	439137.460529449	439474.609352216	439786.966132071	440074.985190973	440339.113826289	440579.792411752	440797.454497061	440992.526906096	441165.429833807	441316.576941755	441446.375452358	441555.226241835	441643.523931871	441711.656980028	441760.007768907	441788.952694083	441798.862250831	441790.101119652	441763.028250622	441717.996946575	441655.354945140	441575.444499637	441478.602458862	441365.160345763	441235.444435027	441089.775829592	440928.470536098	440751.839539293	440560.188875400	440353.819704473	440133.028381742	439898.106527966	439649.341098807	439387.014453240	439111.404421006	438822.784369130	438521.423267505	438207.585753565	437881.532196052	437543.518757895	437193.797458203	436832.616233402	436460.218997505	436076.845701542	435682.732392162	435278.111269402	434863.210743658	434438.255491848	434003.466512786	433559.061181784	433105.253304479	432642.253169908	432170.267602831	431689.500015323	431200.150457632	430702.415668323	430196.489123716	429682.561086625	429160.818654404	428631.445806323	428094.623450265	427550.529468765	426999.338764403	426441.223304542	425876.352165446	425304.891575758	424727.004959374	424142.852977699	423552.593571306	422956.382001003	422354.370888316	421746.710255395	421133.547564354	420515.027756044	419891.293288283	419262.484173532	418628.738016040	417990.190048453	417346.973167900	416699.217971573	416047.052791781	415390.603730518	414729.994693527	414065.347423879	413396.781535069	412724.414543637	412048.361901325	411368.737026764	410685.651336713	409999.214276848	409309.533352099	408616.714156564	407920.860402981	407222.073951782	406520.454839720	405816.101308092	405109.109830552	404399.575140512	403687.590258163	402973.246517093	402256.633590526	401537.839517174	400816.950726723	400094.052064943	399369.226818434	398642.556739016	397914.122067764	397184.001558687	396452.272502071	395719.010747478	394984.290726407	394248.185474635	393510.766654216	392772.104575176	392032.268216875	391291.325249070	390549.342052663	389806.383740146	389062.514175745	388317.795995275	387572.290625697	386826.058304390	386079.158098141	385331.647921857	384583.584556996	383835.023669735	383086.019828861	382336.626523410	381586.896180033	380836.880180116	380086.628876638	379336.191610792	378585.616728345	377834.951595768	377084.242616125	376333.535244716	375582.874004503	374832.302501300	374081.863438731	373331.598632978	372581.549027301	371831.754706343	371082.254910225	370333.088048427	369584.291713463	368835.902694355	368087.956989899	367340.489821737	366593.535647234	365847.128172160	365101.300363179	364356.084460160	363611.511988290	362867.613770015	362124.419936798	361381.959940699	360640.262565780	359899.355939344	359159.267542992	358420.024223527	357681.652203684	356944.177092699	356207.623896721	355472.017029061	354737.380320293	354003.737028191	353271.109847528	352539.520919712	351808.991842286	351079.543678278	350351.196965411	349623.971725166	348897.887471718	348172.963220723	347449.217497978	346726.668347946	346005.333342151	345285.229587441	344566.373734128	343848.781984001	343132.470098214	342417.453405056];
% 
% X0(4*N+1:5*N) = [98595	98297.2060268960	97822.1344341784	97307.1101281168	96777.4587975020	96242.0988820185	95705.1138196630	95168.6739364879	94634.0489423332	94102.0321064427	93573.1424716217	93047.7308111327	92526.0393237178	92008.2372573719	91494.4431882987	90984.7395074226	90479.1821550564	89977.8073493233	89480.6363515786	88987.6789143155	88498.9358231854	88014.4008027148	87534.0619664799	87057.9029355314	86585.9037114663	86118.0413654882	85654.2905876908	85194.6241289199	84739.0131591912	84287.4275606456	83839.8361686771	83396.2069716811	82956.5072775007	82520.7038528788	82088.7630408732	81660.6508601703	81236.3330894385	80815.7753392456	80398.9431135872	79985.8018626892	79576.3170284482	79170.4540836314	78768.1785657668	78369.4561064937	77974.2524570213	77582.5335102351	77194.2653199095	76809.4141174105	76427.9463262188	76049.8285745509	75675.0277063197	75303.5107906370	74935.2451300374	74570.1982675745	74208.3379929227	73849.6323475987	73494.0496294038	73141.5583961729	72792.1274689087	72445.7259343666	72102.3231471505	71761.8887313710	71424.3925819123	71089.8048653490	70758.0960205481	70429.2367589893	70103.1980648322	69779.9511947545	69459.4676775872	69141.7193137635	68826.6781746030	68514.3166014458	68204.6072046521	67897.5228624807	67593.0367198582	67291.1221870501	66991.7529382434	66694.9029100502	66400.5462999393	66108.6575646052	65819.2114182787	65532.1828309871	65247.5470267688	64965.2794818478	64685.3559227717	64407.7523245191	64132.4449085785	63859.4101410042	63588.6247304497	63320.0656261851	63053.7100160981	62789.5353246828	62527.5192110180	62267.6395667376	62009.8745139946	61754.2024034204	61500.6018120813	61249.0515414345	60999.5306152828	60752.0182777316	60506.4939911485	60262.9374341260	60021.3284994492	59781.6472920687	59543.8741270809	59307.9895277137	59073.9742233222	58841.8091473912	58611.4754355481	58382.9544235849	58156.2276454906	57931.2768314944	57708.0839061200	57486.6309862514	57266.9003792107	57048.8745808481	56832.5362736446	56617.8683248270	56404.8537844965	56193.4758837702	55983.7180329366	55775.5638196241	55568.9970069836	55364.0015318851	55160.5615031285	54958.6611996683	54758.2850688526	54559.4177246770	54362.0439460520	54166.1486750858	53971.7170153810	53778.7342303465	53587.1857415230	53397.0571269246	53208.3341193932	53021.0026049693	52835.0486212760	52650.4583559185	52467.2181448979	52285.3144710394	52104.7339624349	51925.4633909008	51747.4896704495	51570.7998557752	51395.3811407550	51221.2208569631	51048.3064721999	50876.6255890353	50706.1659433655	50536.9154029846	50368.8619661692	50201.9937602780	50036.2990403641	49871.7661878018	49708.3837089266	49546.1402336885	49385.0245143199	49225.0254240151	49066.1319556248	48908.3332203625	48751.6184465248	48595.9769782243	48441.3982741353	48287.8719062530	48135.3875586645	47983.9350263327	47833.5042138935	47684.0851344639	47535.6679084640	47388.2427624503	47241.8000279608	47096.3301403736	46951.8236377754	46808.2711598439	46665.6634467399	46523.9913380129	46383.2457715166	46243.4177823370	46104.4985017312	45966.4791560776	45829.3510658372	45693.1056445256	45557.7343976968	45423.2289219368	45289.5809038682	45156.7821191663	45024.8244315838	44893.6997919884	44763.4002374084	44633.9178900899	44505.2449565638	44377.3737267229	44250.2965729083	44124.0059490068	43998.4943895568	43873.7545088650	43749.7790001316	43626.5606345857	43504.0922606295	43382.3668029926	43261.3772618945	43141.1167122167	43021.5783026838	42902.7552550535	42784.6408633153	42667.2284928977	42550.5115798848	42434.4836302403	42319.1382190415	42204.4689897200	42090.4696533116	41977.1339877148	41864.4558369562	41752.4291104653	41641.0477823559	41530.3058907167	41420.1975369086	41310.7168848702	41201.8581604311	41093.6156506322	40985.9837030541	40878.9567251523	40772.5291835999	40666.6956036379	40561.4505684324	40456.7887184382	40352.7047507708	40249.1934185842	40146.2495304557	40043.8679497782	39942.0435941584	39840.7714348219	39740.0464960251	39639.8638544732	39540.2186387451	39441.1060287241	39342.5212550351	39244.4595984887	39146.9163895300	39049.8870076951	38953.3668810722	38857.3514857697	38761.8363453896	38666.8170305073	38572.2891581560	38478.2483913184	38384.6904384227	38291.6110528449	38199.0060324161	38106.8712189362	38015.2024976917	37923.9957969797	37833.2470876370	37742.9523825745	37653.1077363162	37563.7092445444	37474.7530436487	37386.2353102808	37298.1522609141	37210.5001514082	37123.2752765777	37036.4739697666	36950.0926024269	36864.1275837021	36778.5753600151	36693.4324146608	36608.6952674033	36524.3604740774	36440.4246261945	36356.8843505534	36273.7363088544	36190.9771973185	36108.6037463109	36026.6127199679	35945.0009158285	35863.7651644701	35782.9023291482	35702.4093054398	35622.2830208911	35542.5204346689	35463.1185372160	35384.0743499103	35305.3849247279	35227.0473439097	35149.0587196315	35071.4161936785	34994.1169371226	34917.1581500038	34840.5370610147	34764.2509271890	34688.2970335932	34612.6726930215	34537.3752456943	34462.4020589602	34387.7505270012	34313.4180705406	34239.4021365554	34165.7001979903	34092.3097534763	34019.2283270515	33946.4534678854];

X0(1:N) = 21910;     % E(0)
X0(N+1:2*N) = 5587;   % M(0)
X0(2*N+1:3*N) = 13419; % F(0)
X0(3*N+1:4*N) = 0;   % M_s(0)
X0(4*N+1:5*N) = 10^5; % controlo u inicial 
%lb = zeros(5*N, 1);
%ub = zeros(5*N, 1) + 10^5;
ub = [];
lb = [];
JI = J(X0);

options = optimoptions('fmincon', 'MaxFunctionEvaluations', 10^5, 'Algorithm','sqp');

tic
[X_opt, JMin, exitflag, output] = fmincon(J, X0, [], [], [], [], lb, ub, nonlcon, options);
runtime = toc;

x = [X_opt(1:N)'; X_opt(N+1:2*N)'; X_opt(2*N+1:3*N)'; X_opt(3*N+1:4*N)'];
u = X_opt(4*N+1:5*N);

x(:, 1) = [21910; 5587; 13419; 0];

T = 0:h:D;
%Plot of E, M and F
figure;
plot(T, x(1,:), 'Color', [0 0.4470 0.7410], 'DisplayName', ...
    'Mosquito eggs E', LineWidth=1.5);
hold on;
plot(T, x(2,:), 'Color', [0.8500 0.3250 0.0980], 'DisplayName', ...
    'Male mosquitoes M', LineWidth=1.5);
plot(T, x(3,:), 'Color', [0.4940 0.1840 0.5560], 'DisplayName', ...
    'Female mosquitoes F', LineWidth=1.5);
xlabel('Time (days)');
ylabel('Population');
legend;
title('Plot of E, M and F')
pbaspect([2 1 1]); 
hold off;

%Plot of M_s
figure;
plot(T, x(4,:), 'Color', [0.4660 0.6740 0.1880], 'DisplayName', ...
    'Sterilized male mosquitoes M_s', LineWidth=1.5);
xlabel('Time (days)');
ylabel('Population');
legend;
title('Plot of M_s');
pbaspect([2 1 1]);

%Plot of the control u
figure;
plot(T, u, 'Color', [0.6350 0.0780 0.1840], 'DisplayName', ...
    'Control function u', LineWidth=1.5);
xlabel('Time (days)');
ylabel('Release rate');
legend;
title('Plot of the control u');
pbaspect([2 1 1]); 

TM_s = trapz(T, u);